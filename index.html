<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ChÃºc má»«ng 20/10 ğŸŒ¸</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  :root{
    --pink1:#ffd7ea;
    --pink2:#ffecf8;
    --accent:#ff4d8a;
    --accent-2:#ff9ac4;
    --glass: rgba(255,255,255,0.92);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    background: linear-gradient(135deg,var(--pink1),var(--pink2));
    font-family: "Inter", "Segoe UI", Arial, sans-serif;
    display:flex;align-items:center;justify-content:center;
    color:#3a2a34;padding:18px;
    -webkit-font-smoothing:antialiased;
  }

  .wrap{
    width:100%;max-width:980px;background:linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.98));
    border-radius:20px;padding:28px;box-shadow: 0 20px 60px rgba(140,50,100,0.08); position:relative; overflow:hidden;
  }

  .heading{
    display:flex;gap:14px;align-items:center;margin-bottom:8px;
  }
  .logo{
    width:74px;height:74px;border-radius:16px;background:linear-gradient(135deg,#fff0f6,#ffdff0);
    display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800;font-size:26px;
    box-shadow: 0 8px 22px rgba(255,90,150,0.12);
  }
  h1{font-size:24px;color:var(--accent);margin:0}
  p.sub{color:#6b4a63;margin-top:6px;font-weight:600}

  /* Main stage */
  .stage{display:flex;gap:26px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-top:12px}
  .left{flex:1 1 420px;min-width:260px}
  .right{width:360px;min-width:240px;height:420px;border-radius:16px;background:linear-gradient(180deg,#fffafc,#fff0f7);display:flex;align-items:center;justify-content:center;position:relative;box-shadow: 0 18px 50px rgba(160,60,120,0.08)}
  .right .heart{position:absolute;top:18px;right:18px;font-size:28px}

  /* Question center */
  .question-wrap{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:34px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,0.7), rgba(255,255,255,0.82));box-shadow: 0 12px 30px rgba(120,40,80,0.06)}
  .question-text{font-size:22px;color:#5a3750;font-weight:800;margin-bottom:18px;text-align:center}
  .buttons{display:flex;gap:18px;align-items:center}
  .btn{
    border:none;padding:14px 26px;border-radius:12px;font-weight:800;font-size:16px;cursor:pointer;
    box-shadow: 0 10px 28px rgba(140,50,100,0.08); transition: transform .18s ease, box-shadow .18s ease, width .18s ease, height .18s ease;
    user-select:none;
  }
  .btn:active{transform:scale(.98)}
  .btn-no{background:linear-gradient(180deg,#fff7fb,#ffeef6); color:#b04a7f;border:2px solid rgba(176,74,127,0.08)}
  .btn-yes{background:linear-gradient(90deg,#ff6b9a,#ff8cc6); color:white;border:0}

  /* Loading overlay */
  .loading-screen{position:fixed;inset:0;background:linear-gradient(180deg, rgba(10,10,12,0.55), rgba(10,10,12,0.85));display:none;align-items:center;justify-content:center;z-index:1300;backdrop-filter: blur(6px)}
  .loading-card{width:90%;max-width:720px;background:var(--glass);padding:26px;border-radius:14px;text-align:center;box-shadow: 0 30px 80px rgba(10,10,12,0.18)}
  .loading-title{font-family:"Courier New", monospace;font-weight:800;color:#7b4b66;margin-bottom:12px}
  .progress-outer{width:100%;height:18px;background:rgba(0,0,0,0.06);border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,0.5)}
  .progress-inner{height:100%;width:0%;background:linear-gradient(90deg,#ff6b9a,#ffd36f,#ffd3f0);transition:width .12s linear}

  /* Message screen */
  .message-screen{position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:1500}
  .message-inner{width:92%;max-width:820px;padding:26px;border-radius:16px;background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.995));text-align:center;box-shadow: 0 30px 80px rgba(160,60,120,0.08)}
  .msg-title{font-size:36px;color:#ff4d8a;font-weight:900;margin-bottom:6px}
  .msg-sub{color:#6b4a63;margin-bottom:12px}
  .wish-lines{font-size:18px;color:#5a3a52;line-height:1.7;margin-bottom:12px;font-weight:600}

  /* particles layer */
  .particles{position:fixed;inset:0;pointer-events:none;z-index:1400;overflow:hidden}

  /* small responsive */
  @media (max-width:760px){
    .stage{flex-direction:column-reverse;align-items:center}
    .right{width:92%;height:340px}
    .question-text{font-size:20px}
  }
</style>
</head>
<body>
  <div class="wrap" role="main" aria-label="ChÃºc má»«ng 20/10">
    <div class="heading">
      <div class="logo">20</div>
      <div>
        <h1>ChÃºc má»«ng 20/10 â€” NgÃ y Phá»¥ Ná»¯ Viá»‡t Nam NÃ¨ ğŸ‡»ğŸ‡³ğŸ’</h1>
        <p class="sub">Má»™t mÃ³n quÃ  áº£o nhá» nÃ¨ â€” nháº¥n tráº£ lá»i nhÃ©!</p>
      </div>
    </div>

    <div class="stage">
      <div class="left">
        <!-- New main question area (replace previous text as requested) -->
        <div class="question-wrap" aria-labelledby="qtext">
          <div id="qtext" class="question-text">Báº¡n trÆ°á»›c mÃ n hÃ¬nh cÃ³ xinh khÃ´ng nÃ¨ ğŸ«£?</div>
          <div class="buttons" role="group" aria-label="Tráº£ lá»i">
            <button id="btnNo" class="btn btn-no" aria-pressed="false">khÃ´ng</button>
            <button id="btnYes" class="btn btn-yes" aria-pressed="false">cÃ³</button>
          </div>
        </div>

        <div style="margin-top:18px;color:#7d5a78;font-size:13px">
          ( NhÃ¬n ÄÃ¢y Chi Tráº£ Lá»i ÄÃª =)) )
        </div>
      </div>

      <div class="right" aria-hidden="true">
        <div class="heart">ğŸ’˜</div>
        <div style="text-align:center;padding:18px">
          <div style="font-size:16px;color:#6b4a63;font-weight:700">Preview</div>
          <div style="margin-top:8px;color:#8b4e6e">Hoa + Tim + Ã‚m nháº¡c</div>
          <div style="margin-top:14px;font-size:13px;color:#7d5a78">DÃ¹ng Ä‘Æ°á»£c trÃªn GitHub Pages</div>
        </div>
      </div>
    </div>
  </div>

  <!-- loading screen -->
  <div id="loadingScreen" class="loading-screen" role="status" aria-hidden="true">
    <div class="loading-card">
      <div class="loading-title" id="loadingMsg">Ä‘ang Hack Dá»¯ Liá»‡u Äiá»‡n Thoáº¡i =)) Loading...</div>
      <div style="height:10px"></div>
      <div class="progress-outer" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
        <div class="progress-inner" id="progressBar"></div>
      </div>
      <div style="height:10px"></div>
      <div style="font-size:13px;color:#7c5876;margin-top:10px">Äá»£i xÃ­u nha, tá»› Ä‘ang bá»c quÃ  cho cáº­u ğŸ</div>
    </div>
  </div>

  <!-- message screen (final) -->
  <div id="messageScreen" class="message-screen" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="message-inner" id="messageInner">
      <div style="font-size:44px">ğŸŒ¸</div>
      <div class="msg-title">ChÃºc má»«ng 20/10!</div>
      <div class="msg-sub">Gá»­i Ä‘áº¿n cÃ´ gÃ¡i Ä‘áº·c biá»‡t â€” ngÆ°á»i khiáº¿n ngÃ y thÆ°á»ng cÅ©ng ráº¡ng rá»¡ , mÃ  cá»¡ máº·t trá»i cÅ©ng pháº£i bá»¡ ngá»¡ vÃ¬ Cáº­uğŸ¤“</div>

      <div class="wish-lines" id="wishLines">
        <div>ğŸ’ ChÃºc cáº­u luÃ´n xinh tÆ°Æ¡i nhÆ° hoa,</div>
        <div>âœ¨ má»—i ngÃ y Ä‘á»u ngáº­p trÃ n ná»¥ cÆ°á»i vÃ  niá»m vui,</div>
        <div>ğŸŒŸ má»i dá»± Ä‘á»‹nh há»c hÃ nh, cÃ´ng viá»‡c Ä‘á»u thuáº­n lá»£i,</div>
        <div>ğŸ’– vÃ  luÃ´n gáº·p may máº¯n trong chuyá»‡n tÃ¬nh cáº£m ná»¯a nhÃ©!</div>
      </div>

      <div style="font-size:13px;color:#7c5876">â€” Gá»­i tá»« Báº¡n Hanh NhÃ¬n Táº­t =))ğŸŒ·</div>
    </div>
  </div>

  <!-- particles (tim + confetti) -->
  <div id="particles" class="particles" aria-hidden="true"></div>

  <!-- background audio (Catbox) -->
  <audio id="bgAudio" loop preload="auto">
    <source src="https://files.catbox.moe/tqi6f7.mov" />
  </audio>

<script>
  // Elements
  const btnNo = document.getElementById('btnNo');
  const btnYes = document.getElementById('btnYes');
  const loadingScreen = document.getElementById('loadingScreen');
  const progressBar = document.getElementById('progressBar');
  const loadingMsg = document.getElementById('loadingMsg');
  const messageScreen = document.getElementById('messageScreen');
  const messageInner = document.getElementById('messageInner');
  const particles = document.getElementById('particles');
  const bgAudio = document.getElementById('bgAudio');

  // state for scaling yes button
  let yesScale = 1;
  const maxScale = 6; // cap to avoid overflow on small screens
  const doubleOnNo = true; // user wanted "gáº¥p Ä‘Ã´i"
  // track number of "no" presses
  let noCount = 0;

  // Try autoplay once
  async function tryAutoPlay() {
    try {
      bgAudio.volume = 0.72;
      await bgAudio.play();
      console.log('Audio autoplay success');
    } catch(e) {
      console.log('Autoplay blocked - will play on user gesture', e);
    }
  }
  tryAutoPlay();

  // animate shrink for "no" and grow for "yes"
  btnNo.addEventListener('click', function(){
    noCount++;
    // shrink "no" slightly each click (min 0.4)
    btnNo.style.transform = 'scale(0.6)';
    btnNo.style.transition = 'transform 180ms ease';
    setTimeout(()=> {
      // reduce a bit more for repeated clicks
      const baseShrink = Math.max(0.18, 1 - 0.12*noCount);
      btnNo.style.transform = `scale(${baseShrink})`;
    }, 200);

    // grow "yes" (double if requested)
    if (doubleOnNo) {
      yesScale = Math.min(maxScale, yesScale * 2);
    } else {
      yesScale = Math.min(maxScale, yesScale + 0.4);
    }
    // animate growth
    btnYes.style.transform = `scale(${yesScale})`;
    btnYes.style.transition = 'transform 260ms cubic-bezier(.2,.9,.3,1)';
    // subtle pulse and shadow
    btnYes.style.boxShadow = '0 18px 48px rgba(255,80,150,0.18)';

    // small playful wiggle on no to keep it cute
    btnNo.animate([
      { transform: 'translateX(0px) rotate(0deg)' },
      { transform: 'translateX(-6px) rotate(-6deg)' },
      { transform: 'translateX(0px) rotate(0deg)' }
    ], {duration: 380, easing: 'ease-out'});
  });

  // If user clicks 'yes' -> go to loading sequence
  btnYes.addEventListener('click', async function(){
    // ensure audio plays
    try{ await bgAudio.play(); } catch(e){ console.log('play blocked', e) }
    startLoadingSequence();
  });

  // Allow keyboard activation (accessibility)
  [btnNo, btnYes].forEach(btn => {
    btn.addEventListener('keyup', (e) => {
      if (e.key === 'Enter' || e.key === ' ') btn.click();
    });
  });

  // Loading logic
  function startLoadingSequence(){
    // hide main interactive area (slightly dim)
    document.querySelector('.wrap').style.filter = 'brightness(.85)';
    loadingScreen.style.display = 'flex';
    loadingScreen.setAttribute('aria-hidden','false');

    // cycle messages
    const msgs = [
      'Ä‘ang gÃ³i quÃ  xinh xáº¯n...',
      'Ä‘ang tháº£ tim nhá» nhá»...',
      'Ä‘ang bá»c hoa áº£o...',
      'Ä‘ang soáº¡n lá»i chÃºc dá»… thÆ°Æ¡ng...',
      'sáº¯p xong rá»“i nÃ¨...'
    ];
    let idx = 0;
    const msgTimer = setInterval(()=> {
      loadingMsg.textContent = msgs[idx % msgs.length];
      idx++;
    }, 700);

    // fill progress to 100% smoothly
    const total = 3600 + Math.random()*900; // ~3.6s-4.5s
    const start = performance.now();
    function tick(now){
      const elapsed = now - start;
      const pct = Math.min(100, (elapsed/total)*100);
      progressBar.style.width = pct + '%';
      progressBar.parentElement.setAttribute('aria-valuenow', Math.round(pct));
      if (pct < 100) {
        requestAnimationFrame(tick);
      } else {
        clearInterval(msgTimer);
        setTimeout(()=> {
          // fade to dark then show message
          loadingScreen.style.display = 'none';
          darkThenReveal();
        }, 500);
      }
    }
    requestAnimationFrame(tick);
  }

  // darken then reveal message + spawn particles
  function darkThenReveal(){
    // darken whole page then reveal
    const wrap = document.querySelector('.wrap');
    wrap.animate([
      { filter: 'brightness(0.9)' },
      { filter: 'brightness(0.25)' }
    ], { duration: 420, fill: 'forwards', easing: 'ease-out' });

    // small delay then reveal message
    setTimeout(()=> {
      // show message screen
      messageScreen.style.display = 'flex';
      messageScreen.setAttribute('aria-hidden','false');
      // quick brighten transition of message inner
      messageInner.animate([
        { transform: 'scale(.96)', opacity: 0 },
        { transform: 'scale(1.02)', opacity: 1 }
      ], { duration: 700, easing: 'cubic-bezier(.2,.9,.3,1)' });

      // spawn particles (tim + confetti) repeatedly for a bit
      spawnParticlesBurst();
      const bursts = [500, 1100, 1700, 2300];
      bursts.forEach((t, i) => setTimeout(spawnParticlesBurst, t));
      // restore wrap brightness softly
      setTimeout(()=> wrap.style.filter = '', 1400);
    }, 420);
  }

  // create particle burst of hearts + confetti
  function spawnParticlesBurst(){
    const emojis = ['ğŸ’–','ğŸ’•','ğŸŒ¸','ğŸŒ·','ğŸ€','âœ¨','ğŸ’˜','ğŸ’'];
    const count = 28;
    const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
    for (let i=0;i<count;i++){
      const el = document.createElement('div');
      el.style.position = 'absolute';
      el.style.willChange = 'transform,opacity';
      el.style.pointerEvents = 'none';
      el.textContent = emojis[Math.floor(Math.random()*emojis.length)];
      const size = (Math.random()*22 + 14) + 'px';
      el.style.fontSize = size;
      const left = Math.random()*100;
      el.style.left = left + 'vw';
      const delay = Math.random()*200;
      const dur = 2000 + Math.random()*2200;
      el.style.opacity = 0;
      particles.appendChild(el);

      // animate using setTimeout + requestAnimationFrame for better control
      setTimeout(()=> {
        const start = performance.now();
        function frame(now){
          const t = (now - start)/dur;
          if (t < 1){
            // vertical movement from -10vh to 110vh
            const y = (-10 + t*(120)) + 'vh';
            el.style.transform = `translateY(${y}) rotate(${t*720}deg) scale(${1 - t*0.45})`;
            el.style.opacity = String(Math.min(1, t*1.4));
            requestAnimationFrame(frame);
          } else {
            el.style.opacity = '0';
            if (el && el.parentNode) el.parentNode.removeChild(el);
          }
        }
        requestAnimationFrame(frame);
      }, delay);
    }
  }

  // Try to resume audio on any user gesture too
  ['click','touchstart','keydown'].forEach(ev => {
    document.addEventListener(ev, function resume(){ 
      if (bgAudio.paused) bgAudio.play().catch(()=>{});
      document.removeEventListener(ev, resume);
    }, {passive:true});
  });

  // close message on click (optional)
  messageScreen.addEventListener('click', function(){
    // keep message visible by default per your request; here click will not close
    // but we'll add a subtle ripple to indicate interaction
    messageInner.animate([
      { transform: 'scale(1)' },
      { transform: 'scale(0.995)' },
      { transform: 'scale(1)' }
    ], { duration: 260, easing: 'ease-out' });
  });

  // Accessibility: Enter key to click yes if focused
  btnYes.addEventListener('keyup', (e) => { if (e.key === 'Enter') btnYes.click(); });
  btnNo.addEventListener('keyup', (e) => { if (e.key === 'Enter') btnNo.click(); });

  // Helpful: ensure the "yes" button doesn't overflow the screen (responsive)
  // If scale becomes too large we can bring it back a bit for UX
  const resizeObserver = new ResizeObserver(() => {
    // keep yesScale reasonable relative to viewport width
    const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
    if (yesScale > 1 && vw < 420 && yesScale > 3) {
      yesScale = Math.max(1.6, yesScale/1.6);
      btnYes.style.transform = `scale(${yesScale})`;
    }
  });
  resizeObserver.observe(document.documentElement);

  // make initial micro animation to entice click
  setTimeout(()=> {
    btnYes.animate([
      { transform: 'translateY(0px) scale(1)' },
      { transform: 'translateY(-6px) scale(1.02)' },
      { transform: 'translateY(0px) scale(1)' }
    ], { duration: 900, iterations: Infinity, easing: 'ease-in-out' });
  }, 600);
</script>
<!-- === Báº®T Äáº¦U: thÃªm vÃ o cuá»‘i index.html (TRÆ¯á»šC </body>) === -->
<style>
  /* styles bá»• sung, an toÃ n Ä‘á»ƒ append */
  #__upgrade_seq_overlay {
    position: fixed;
    inset: 0;
    display: none;
    z-index: 99999;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.95);
    color: #fff;
    text-align: center;
    padding: 18px;
    flex-direction: column;
    gap: 16px;
  }
  #__upgrade_seq_text { font-size: 20px; line-height:1.4; max-width:88vw; }
  #__upgrade_seq_gif { max-width: 86vw; border-radius: 12px; box-shadow: 0 12px 40px rgba(0,0,0,0.6); display:block; }
  #__upgrade_loader {
    position: fixed;
    inset: 0;
    display:none;
    z-index: 99998;
    align-items:center;
    justify-content:center;
    background: rgba(0,0,0,0.88);
    color:#fff;
    flex-direction:column;
    gap:12px;
  }
  #__upgrade_loader_bar {
    width: 64vw; max-width:520px; height:12px; background: rgba(255,255,255,0.12);
    border-radius: 999px; overflow:hidden;
  }
  #__upgrade_loader_bar_inner { height:100%; width:0%; background: linear-gradient(90deg, rgba(255,255,255,0.18), rgba(255,255,255,0.32)); transition: width 420ms linear; }
  #__upgrade_final_msg {
    position: fixed;
    inset: 0;
    display:none;
    z-index: 99997;
    align-items:center;
    justify-content:center;
    background: rgba(255,255,255,0.02);
    color: #fff;
    padding: 20px;
    text-align:center;
  }
  #__upgrade_final_msg .card { background: rgba(0,0,0,0.6); padding:20px; border-radius:12px; box-shadow: 0 12px 30px rgba(0,0,0,0.5); }
</style>

<div id="__upgrade_seq_overlay" aria-hidden="true">
  <div id="__upgrade_seq_text" aria-live="polite"></div>
  <div id="__upgrade_seq_gif_wrap" style="display:none;">
    <img id="__upgrade_seq_gif" alt="gif" />
  </div>
</div>

<div id="__upgrade_loader" aria-hidden="true">
  <div style="font-weight:600">Äang chuáº©n bá»‹...</div>
  <div id="__upgrade_loader_bar"><div id="__upgrade_loader_bar_inner"></div></div>
  <div id="__upgrade_loader_msg" style="opacity:.9;font-size:14px;padding-top:6px">Vui lÃ²ng chá»...</div>
</div>

<div id="__upgrade_final_msg" aria-hidden="true">
  <div class="card">
    <div style="font-size:20px;font-weight:700">Lá»i chÃºc</div>
    <div style="margin-top:10px" id="__upgrade_final_text">Cáº£m Æ¡n báº¡n â€” chÃºc báº¡n má»™t ngÃ y tháº­t tuyá»‡t!</div>
  </div>
</div>

<script>
(function(){
  // === Cáº¥u hÃ¬nh (khÃ´ng Ä‘á»•i code gá»‘c) ===
  const MP3_URL = 'https://files.catbox.moe/39azma.mp3';
  const MP4_URL = 'https://files.catbox.moe/t0cprg.mp4';
  const GIF_URL = 'https://media.giphy.com/media/lxxOGaDRk4f7R5TkBd/giphy.gif';
  const MIN_MP3_MS = 4000; // tá»‘i thiá»ƒu 4s
  const MIN_MP4_MS = 8000; // tá»‘i thiá»ƒu 8s

  // === pháº§n tá»­ bá»• sung ===
  const overlay = document.getElementById('__upgrade_seq_overlay');
  const overlayText = document.getElementById('__upgrade_seq_text');
  const gifWrap = document.getElementById('__upgrade_seq_gif_wrap');
  const gifImg = document.getElementById('__upgrade_seq_gif');
  const loader = document.getElementById('__upgrade_loader');
  const loaderInner = document.getElementById('__upgrade_loader_bar_inner');
  const loaderMsg = document.getElementById('__upgrade_loader_msg');
  const finalMsg = document.getElementById('__upgrade_final_msg');
  const finalText = document.getElementById('__upgrade_final_text');

  // find background audio element (try common ids or first <audio>)
  function findBgAudio(){
    const byId = ['bgAudio','audio','backgroundAudio','bg-audio'];
    for (const id of byId){
      const el = document.getElementById(id);
      if (el && el.tagName && el.tagName.toLowerCase()==='audio') return el;
    }
    const firstAudio = document.querySelector('audio');
    if (firstAudio) return firstAudio;
    // fallback: no audio found
    return null;
  }

  const bgAudio = findBgAudio();

  // robust find of "cÃ³" button: prefer id btnYes, else find elements with innerText 'cÃ³'
  function findYesButton(){
    const pref = document.getElementById('btnYes') || document.querySelector('[data-yes]');
    if (pref) return pref;
    const buttons = Array.from(document.querySelectorAll('button, a, input[type="button"], [role="button"]'));
    for (const b of buttons){
      try{
        if ((b.innerText || b.value || '').trim().toLowerCase() === 'cÃ³') return b;
      }catch(e){}
    }
    // last resort - first clickable element
    return buttons[0] || null;
  }

  const yesBtn = findYesButton();
  if (!yesBtn){
    // nothing to attach to; do nothing further (but keep original code untouched)
    return;
  }

  // avoid double attachment
  if (yesBtn.dataset.__upgradeAttached) return;
  yesBtn.dataset.__upgradeAttached = '1';

  // promise helper to play audio and resolve on end or after min timeout
  function playAudioOnceTimed(src, minMs){
    return new Promise((resolve) => {
      const a = new Audio(src);
      a.preload = 'auto';
      let settled = false;
      function cleanup(){
        if (settled) return;
        settled = true;
        try{ a.pause(); }catch(e){}
        resolve();
      }
      a.addEventListener('ended', () => cleanup());
      a.addEventListener('error', () => cleanup());
      // safety by minMs anyway
      const t = setTimeout(() => cleanup(), minMs + 600);
      a.play().catch(()=>{ /* autoplay might block; still wait minMs then resolve */ });
    });
  }

  // helper to play audio and return when ended or after timeout (ms)
  function playMediaWait(src, timeoutMs){
    return new Promise((resolve) => {
      let done = false;
      const a = new Audio(src);
      a.preload = 'auto';
      a.loop = false;
      a.addEventListener('ended', ()=>{ if (!done){ done=true; resolve(); } });
      a.addEventListener('error', ()=>{ if (!done){ done=true; resolve(); } });
      a.play().catch(()=>{ /* play may be blocked; still fallback to timeout */ });
      setTimeout(()=>{ if (!done){ done=true; resolve(); } }, timeoutMs + 500);
    });
  }

  // fade helpers (do not remove any existing elements)
  function fadeInOverlay(){
    overlay.style.display = 'flex';
    overlay.style.opacity = '0';
    const anim = overlay.animate([{opacity:0},{opacity:1}], {duration:420, fill:'forwards', easing:'ease-out'});
    return new Promise(res=> anim.onfinish = res);
  }
  function fadeOutOverlay(){
    const anim = overlay.animate([{opacity:1},{opacity:0}], {duration:380, fill:'forwards', easing:'ease-out'});
    return new Promise(res=> anim.onfinish = ()=>{ overlay.style.display='none'; res(); });
  }

  function fadeToBlackOnRoot(duration=420){
    // attempt to dim main content but not touch original code
    const root = document.querySelector('body') || document.documentElement;
    const anim = root.animate([{filter: 'brightness(1)'},{filter:'brightness(0.06)'}], {duration, fill:'forwards', easing:'ease-out'});
    return new Promise(res=> anim.onfinish = res);
  }
  function restoreBrightness(duration=360){
    const root = document.querySelector('body') || document.documentElement;
    const anim = root.animate([{filter:'brightness(0.06)'},{filter:''}], {duration, fill:'forwards', easing:'ease-out'});
    return new Promise(res=> anim.onfinish = res);
  }

  // loader simulation
  function showLoaderThenReveal(finalTextStr){
    loader.style.display = 'flex';
    loader.setAttribute('aria-hidden','false');
    loaderInner.style.width = '2%';
    loaderMsg.innerText = 'Äang chuáº©n bá»‹...';
    let start = performance.now();
    const duration = 3600 + Math.random()*900; // ~3.6s - 4.5s
    return new Promise(res=>{
      function frame(now){
        const pct = Math.min(100, ((now - start)/duration)*100);
        loaderInner.style.width = pct + '%';
        if (pct < 100) requestAnimationFrame(frame);
        else {
          setTimeout(()=> {
            loader.style.display = 'none';
            loader.setAttribute('aria-hidden','true');
            finalText.innerText = finalTextStr || 'Mong báº¡n thÃ­ch!';
            finalMsg.style.display = 'flex';
            finalMsg.setAttribute('aria-hidden','false');
            res();
          }, 420);
        }
      }
      requestAnimationFrame(frame);
    });
  }

  // main orchestrator
  async function runSequence(){
    try{
      // 1) fade to black and stop bg audio
      await fadeToBlackOnRoot(480);
      if (bgAudio && !bgAudio.paused){
        try{ bgAudio.pause(); bgAudio.currentTime = 0; } catch(e){}
      }

      // 2) show sentence
      overlayText.textContent = 'trÃ¡i Ä‘áº¥t thÃ¬ cÃ³ máº·t trá»i , cÃ²n anh thÃ¬ cÃ³ 1 Ä‘á»i bÃªn em';
      gifWrap.style.display = 'none';
      await fadeInOverlay();

      // 3) play mp3 but wait at least MIN_MP3_MS or until ended
      await Promise.race([ playMediaWait(MP3_URL, MIN_MP3_MS), new Promise(r=>setTimeout(r, MIN_MP3_MS)) ]);

      // 4) show gif
      gifImg.src = GIF_URL;
      gifWrap.style.display = 'block';
      // small visual pause to allow gif to appear
      await new Promise(r => setTimeout(r, 420));

      // 5) play mp4 as audio and wait at least MIN_MP4_MS or until ended
      await Promise.race([ playMediaWait(MP4_URL, MIN_MP4_MS), new Promise(r=>setTimeout(r, MIN_MP4_MS)) ]);

      // 6) hide overlay and show loader
      await fadeOutOverlay();
      await restoreBrightness(260);

      // 7) show loader, then re-enable bgAudio (if exists)
      await showLoaderThenReveal('Lá»i chÃºc: YÃªu báº¡n vÃ´ háº¡n â™¥');
      if (bgAudio){
        try{ bgAudio.currentTime = 0; bgAudio.play().catch(()=>{}); }catch(e){}
      }

      // 8) done (final message visible). Keep final message until user closes (do not auto remove)
    }catch(err){
      // If anything fails, ensure we try to restore visual and audio
      try{ overlay.style.display='none'; loader.style.display='none'; finalMsg.style.display='flex'; if(bgAudio){ bgAudio.play().catch(()=>{}); } }catch(e){}
      console.error('upgrade sequence error', err);
    }
  }

  // attach handler to yesBtn
  yesBtn.addEventListener('click', function(e){
    // do not prevent original handlers â€” we append behavior after a tiny delay so original code runs too
    // run sequence asynchronously
    setTimeout(()=>{ runSequence().catch(()=>{}); }, 40);
  }, {passive:true});

})();
</script>
<!-- === Káº¾T THÃšC: Ä‘oáº¡n bá»• sung (append) === -->
</body>
</html>.min(maxScale, yesScale + 0.4);
    }
    btnYes.style.transform = `scale(${yesScale})`;
    btnYes.style.transition = 'transform 260ms cubic-bezier(.2,.9,.3,1)';
    btnYes.style.boxShadow = '0 18px 48px rgba(255,80,150,0.18)';

    btnNo.animate([
      { transform: 'translateX(0px) rotate(0deg)' },
      { transform: 'translateX(-6px) rotate(-6deg)' },
      { transform: 'translateX(0px) rotate(0deg)' }
    ], {duration: 380, easing: 'ease-out'});
  });

  btnYes.addEventListener('click', async function(){
    try{ await bgAudio.play(); } catch(e){}
    startLoadingSequence();
  });

  [btnNo, btnYes].forEach(btn => {
    btn.addEventListener('keyup', (e) => {
      if (e.key === 'Enter' || e.key === ' ') btn.click();
    });
  });

  function startLoadingSequence(){
    document.querySelector('.wrap').style.filter = 'brightness(.85)';
    loadingScreen.style.display = 'flex';
    loadingScreen.setAttribute('aria-hidden','false');
    const msgs = [
      'Ä‘ang gÃ³i quÃ  xinh xáº¯n...',
      'Ä‘ang tháº£ tim nhá» nhá»...',
      'Ä‘ang bá»c hoa áº£o...',
      'Ä‘ang soáº¡n lá»i chÃºc dá»… thÆ°Æ¡ng...',
      'sáº¯p xong rá»“i nÃ¨...'
    ];
    let idx = 0;
    const msgTimer = setInterval(()=> {
      loadingMsg.textContent = msgs[idx % msgs.length];
      idx++;
    }, 700);
    const total = 3600 + Math.random()*900;
    const start = performance.now();
    function tick(now){
      const elapsed = now - start;
      const pct = Math.min(100, (elapsed/total)*100);
      progressBar.style.width = pct + '%';
      progressBar.parentElement.setAttribute('aria-valuenow', Math.round(pct));
      if (pct < 100) requestAnimationFrame(tick);
      else {
        clearInterval(msgTimer);
        setTimeout(()=> { loadingScreen.style.display = 'none'; darkThenReveal(); }, 500);
      }
    }
    requestAnimationFrame(tick);
  }

  function darkThenReveal(){
    const wrap = document.querySelector('.wrap');
    wrap.animate([{ filter: 'brightness(0.9)' }, { filter: 'brightness(0.25)' }], { duration: 420, fill: 'forwards', easing: 'ease-out' });
    setTimeout(()=> {
      messageScreen.style.display = 'flex';
      messageScreen.setAttribute('aria-hidden','false');
      messageInner.animate([{ transform: 'scale(.96)', opacity: 0 }, { transform: 'scale(1.02)', opacity: 1 }], { duration: 700, easing: 'cubic-bezier(.2,.9,.3,1)' });
      spawnParticlesBurst();
      const bursts = [500, 1100, 1700, 2300];
      bursts.forEach((t)=> setTimeout(spawnParticlesBurst, t));
      setTimeout(()=> wrap.style.filter = '', 1400);
    }, 420);
  }

  function spawnParticlesBurst(){
    const emojis = ['ğŸ’–','ğŸ’•','ğŸŒ¸','ğŸŒ·','ğŸ€','âœ¨','ğŸ’˜','ğŸ’','ğŸ‰','ğŸ”†'];
    const count = 28;
    const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
    for (let i=0;i<count;i++){
      const el = document.createElement('div');
      el.style.position = 'absolute';
      el.style.willChange = 'transform,opacity';
      el.style.pointerEvents = 'none';
      el.textContent = emojis[Math.floor(Math.random()*emojis.length)];
      const size = (Math.random()*22 + 14) + 'px';
      el.style.fontSize = size;
      const left = Math.random()*100;
      el.style.left = left + 'vw';
      const delay = Math.random()*200;
      const dur = 2000 + Math.random()*2200;
      el.style.opacity = 0;
      particles.appendChild(el);

      setTimeout(()=> {
        const start = performance.now();
        function frame(now){
          const t = (now - start)/dur;
          if (t < 1){
            const y = (-10 + t*(120)) + 'vh';
            el.style.transform = `translateY(${y}) rotate(${t*720}deg) scale(${1 - t*0.45})`;
            el.style.opacity = String(Math.min(1, t*1.4));
            requestAnimationFrame(frame);
          } else {
            el.style.opacity = '0';
            if (el && el.parentNode) el.parentNode.removeChild(el);
          }
        }
        requestAnimationFrame(frame);
      }, delay);
    }
  }

  ['click','touchstart','keydown'].forEach(ev => {
    document.addEventListener(ev, function resume(){ 
      if (bgAudio.paused) bgAudio.play().catch(()=>{});
      document.removeEventListener(ev, resume);
    }, {passive:true});
  });

  messageScreen.addEventListener('click', function(){
    messageInner.animate([{ transform: 'scale(1)' }, { transform: 'scale(0.995)' }, { transform: 'scale(1)' }], { duration: 260, easing: 'ease-out' });
  });

  const resizeObserver = new ResizeObserver(() => {
    const vw = Math.max(document.documentElement.clientWidth || 0, window.innerWidth || 0);
    if (yesScale > 1 && vw < 420 && yesScale > 3) {
      yesScale = Math.max(1.6, yesScale/1.6);
      btnYes.style.transform = `scale(${yesScale})`;
    }
  });
  resizeObserver.observe(document.documentElement);

  setTimeout(()=> {
    btnYes.animate([{ transform: 'translateY(0px) scale(1)' }, { transform: 'translateY(-6px) scale(1.02)' }, { transform: 'translateY(0px) scale(1)' }], { duration: 900, iterations: Infinity, easing: 'ease-in-out' });
  }, 600);
</script>
</body>
</html>
